<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Raindrops — A MOMENT IN TIME</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;}
body{background:#0a1a0e;display:flex;flex-direction:column;align-items:center;justify-content:center;
min-height:100vh;min-height:100dvh;font-family:'Helvetica Neue',-apple-system,sans-serif;
user-select:none;-webkit-user-select:none;touch-action:none;overflow:hidden;}
canvas{border-radius:12px;cursor:pointer;touch-action:none;box-shadow:0 0 60px rgba(180,140,255,0.06);}
.sub{color:rgba(255,255,255,0.25);font-size:12px;margin-top:10px;letter-spacing:2px;text-align:center;}f
</style>
</head>
<body>
<canvas id="g"></canvas>

<audio id="rain" preload="auto" loop playsinline>
  <source src="audio/rain.mp3" type="audio/mpeg">
</audio>
<p class="sub">RAINDROPS — A MOMENT IN TIME</p>
<script>
// === CONFIG ===
const DROPS_TO_WIN = 20;
const RAIN_INT = 5;          // regular rain spawn interval (dense)
const GLOW_MIN_GAP = 1000;    // minimum ms between glowing drops
const GLOW_MAX_GAP = 2000;    // maximum ms between glowing drops
const HIT_R = 80;
const DENSE = 12;               // regular drops per spawn
const IS_MOBILE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
const QUOTES = [
  "breathe",
  "feel",
  "listen",
  "May your worries be as short lived as a fart on a windy day. — BH",
  "notice",
  "pause",
  "reflect",
  "release",
];
let quoteIndex = 0;

// === AUDIO ===
let actx = null, started = false;
let rainBuffer = null;
let rainGain = null;
let rainPlaying = false;

// Simple <audio> element approach — works with file:// and servers
function useFallback(){
  const rainEl = document.getElementById("rain");
  if(!rainEl) return;
  rainEl.volume = IS_MOBILE ? 1.0 : 0.6;
  rainEl.muted = false;
  if(rainPlaying) rainEl.play().catch(e => console.log("Audio play blocked:", e));
}

function startCrossfadeLoop(){
  useFallback();
}

function stopRainLoop(){
  const rainEl = document.getElementById("rain");
  if(rainEl){ rainEl.pause(); rainEl.currentTime = 0; }
}

function initAudio(){
  if(started) return;
  try{
    actx = new (window.AudioContext || window.webkitAudioContext)();
    rainGain = { gain: { value: IS_MOBILE ? 1.0 : 0.6, cancelScheduledValues: ()=>{}, linearRampToValueAtTime: (val)=>{ document.getElementById("rain").volume = val; } } };
    started = true;
  } catch(e) {}
}

// (keep synth SFX)
function chime(){
  if(!actx) return;
  const freqs=[1568,2093,2637,3136,3520];
  const f=freqs[Math.floor(Math.random()*freqs.length)];
  [f,f*1.002].forEach((freq,i)=>{
    const o=actx.createOscillator(),g=actx.createGain();
    o.type="sine";o.frequency.value=freq;
    g.gain.setValueAtTime(i===0?0.18:0.06,actx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.8);
    o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+0.8);
  });
  const nb=actx.createBufferSource();
  const nBuf=actx.createBuffer(1,actx.sampleRate*0.05,actx.sampleRate);
  const nd=nBuf.getChannelData(0);for(let i=0;i<nd.length;i++)nd[i]=(Math.random()*2-1)*0.3;
  nb.buffer=nBuf;
  const nf=actx.createBiquadFilter();nf.type="bandpass";nf.frequency.value=4000;nf.Q.value=5;
  const ng=actx.createGain();ng.gain.setValueAtTime(0.08,actx.currentTime);
  ng.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+0.15);
  nb.connect(nf);nf.connect(ng);ng.connect(actx.destination);nb.start();
}

function playEnd(){
  if(!actx) return;
  [261.6,329.6,392,523.2].forEach((f,i)=>{
    const o=actx.createOscillator(),g=actx.createGain();
    o.type="sine";o.frequency.value=f;
    g.gain.setValueAtTime(0,actx.currentTime+i*0.3);
    g.gain.linearRampToValueAtTime(0.05,actx.currentTime+i*0.3+0.6);
    g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+i*0.3+4);
    o.connect(g);g.connect(actx.destination);o.start(actx.currentTime+i*0.3);o.stop(actx.currentTime+i*0.3+4);
  });
}

function resetRain(){
  const rainEl = document.getElementById("rain");
  if(!rainEl) return;
  rainEl.volume = IS_MOBILE ? 1.0 : 0.6;
  rainEl.muted = false;
  rainPlaying = true;
  rainEl.play().catch(e => console.log("Audio play blocked:", e));
}
// === CANVAS ===

const cv=document.getElementById("g"),c=cv.getContext("2d");
  // --- roundRect fallback (fixes Firefox / older browsers) ---
if (!c.roundRect) {
  c.roundRect = function(x, y, w, h, r) {
    r = Math.min(r || 0, w / 2, h / 2);
    this.moveTo(x + r, y);
    this.arcTo(x + w, y,     x + w, y + h, r);
    this.arcTo(x + w, y + h, x,     y + h, r);
    this.arcTo(x,     y + h, x,     y,     r);
    this.arcTo(x,     y,     x + w, y,     r);
    this.closePath();
    return this;
  };
}
let sky=null;
function getSize(){const W=window.innerWidth,H=window.innerHeight||document.documentElement.clientHeight;const IS_MOB=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);if(IS_MOB){return{w:Math.floor(W),h:Math.floor(H)};}const mw=Math.min(W*0.98,800),mh=H*0.92;let w=mw,h=mw*(4/3);if(h>mh){h=mh;w=h*(3/4);}return{w:Math.floor(w),h:Math.floor(h)};}
function resize(){const{w,h}=getSize();cv.width=w*2;cv.height=h*2;cv.style.width=w+"px";cv.style.height=h+"px";c.setTransform(2,0,0,2,0,0);sky=null;}
resize();
window.addEventListener("resize", resize);

// === SKYLINE ===
function buildSkyline(w,h){
  const bs=[];let x=-5;
  while(x<w+20){
    const bw=14+Math.random()*38;
    const bh=h*0.12+Math.random()*h*0.48;
    const ant=Math.random()>0.7;
    const wins=[];
    const wC=Math.floor(bw/8),wR=Math.floor(bh/12);
   for (let r = 1; r < wR; r++) {
  for (let cl = 0; cl < wC; cl++) {
    if (Math.random() > 0.75) {
      wins.push({
        rx: 3 + cl * (bw / wC),
        ry: r * 12,
        lit: Math.random() > 0.75,
        flicker: Math.random() > 0.995,
        fSpd: 0.001 + Math.random() * 0.002,
        fPh: Math.random() * Math.PI * 2,
      });
    }
  }
}
    bs.push({x,w:bw,h:bh,ant,aH:10+Math.random()*20,wins});
    x+=bw+2+Math.random()*5;
  }
  return bs;
}
function drawSky(w,h,t){
  if(!sky)sky=buildSkyline(w,h);
  const by=h;
  // City glow
  const gl=c.createRadialGradient(w/2,h,0,w/2,h,h*0.8);
  gl.addColorStop(0,"rgba(60,30,80,0.12)");gl.addColorStop(0.5,"rgba(40,20,60,0.05)");gl.addColorStop(1,"rgba(0,0,0,0)");
  c.fillStyle=gl;c.fillRect(0,0,w,h);

  sky.forEach(b=>{
    c.fillStyle="rgba(8,6,14,0.95)";c.fillRect(b.x,by-b.h,b.w,b.h);
    c.strokeStyle="rgba(60,40,80,0.12)";c.lineWidth=0.5;c.strokeRect(b.x,by-b.h,b.w,b.h);
    if(b.ant){
      const ax=b.x+b.w/2;
      c.strokeStyle="rgba(40,30,60,0.5)";c.lineWidth=1;
      c.beginPath();c.moveTo(ax,by-b.h);c.lineTo(ax,by-b.h-b.aH);c.stroke();
      if(Math.sin(t*0.003+b.x)>0.3){
        c.fillStyle="rgba(255,50,50,0.6)";c.beginPath();c.arc(ax,by-b.h-b.aH,1.5,0,Math.PI*2);c.fill();
        const rg=c.createRadialGradient(ax,by-b.h-b.aH,0,ax,by-b.h-b.aH,8);
        rg.addColorStop(0,"rgba(255,50,50,0.15)");rg.addColorStop(1,"rgba(255,50,50,0)");
        c.fillStyle=rg;c.beginPath();c.arc(ax,by-b.h-b.aH,8,0,Math.PI*2);c.fill();
      }
    }
    b.wins.forEach(win=>{
      let a=win.lit?0.6:0.08;
      if(win.flicker)a*=0.5+0.5*Math.sin(t*win.fSpd+win.fPh);
      if(win.lit){
        const wx=b.x+win.rx,wy=by-b.h+win.ry;
        c.fillStyle=`rgba(255,220,140,${a*0.3})`;c.fillRect(wx-1,wy-1,5,5);
        c.fillStyle=`rgba(255,200,100,${a})`;c.fillRect(wx,wy,3,3);
      } else {
        c.fillStyle=`rgba(30,25,45,${a})`;c.fillRect(b.x+win.rx,by-b.h+win.ry,3,3);
      }
    });
  });
}

// === GAME STATE ===
const gs={
  drops:[],catchPs:[],ripples:[],
  score:0,phase:"menu",
  lastRain:0,nextGlow:0,lastGlowTime:0,
  cloudOff:0,menuPulse:0,
  endT:0,endQuote:"",
  dimAlpha:0,rainFaded:false,
  rbPs:null,quoteStartTime:0,
};

// Schedule next glow drop
function scheduleGlow(){
  gs.nextGlow=Date.now()+GLOW_MIN_GAP+Math.random()*(GLOW_MAX_GAP-GLOW_MIN_GAP);
}

function mkDrop(w,h,forceGlow){
  const gl=forceGlow||false;
  const GLOW_MARGIN=0.12;
  const speedScale = h / 600;
  const xPos=gl?w*GLOW_MARGIN+Math.random()*w*(1-2*GLOW_MARGIN):Math.random()*w;
  return{
    x:xPos,y:-10-Math.random()*50,
    speed:gl?(1.2+Math.random()*0.5)*speedScale:(26.0+Math.random()*18.0)*speedScale,
    length:gl?18+Math.random()*10:3+Math.random()*8,
    opacity:gl?1:0.18+Math.random()*0.65,
    isGlowing:gl,pulsePhase:Math.random()*Math.PI*2,
    width:gl?2.5:0.5+Math.random()*0.7,
    caught:false,fadeOut:1,
    grounded: false,
    drift:gl?0:(Math.random()-0.5)*0.4,
  };
}

function mkFx(x,y){
  const ps=[];
  for(let i=0;i<14;i++){
    const a=(Math.PI*2*i)/14+Math.random()*0.3,s=2+Math.random()*3;
    ps.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,life:1,size:1.5+Math.random()*3,
      color:Math.random()>0.5?"rgba(236,210,255,":"rgba(200,175,255,"});
  }
  return ps;
}

function mkRip(x,y){return{x,y,radius:3,opacity:0.45,speed:1};}

// === INPUT ===
function getPos(e){
  const r = cv.getBoundingClientRect();
  const px = e.touches ? e.touches[0].clientX : e.clientX;
  const py = e.touches ? e.touches[0].clientY : e.clientY;
  return { x: (px - r.left), y: (py - r.top) };
}

function tap(e){
  e.preventDefault();
  initAudio();

  // Start rain loop on first tap
  if(!rainPlaying){
    rainPlaying = true;
    useFallback();
  }
  const p = getPos(e);

  if(gs.phase==="menu"){
    gs.phase="playing";gs.score=0;
    gs.drops=[];gs.catchPs=[];gs.ripples=[];
    gs.endT=0;gs.dimAlpha=0;gs.rainFaded=false;gs.rbPs=null;
    sky=null;scheduleGlow();
    resetRain();lastTick=Date.now();return;
  }

  if(gs.phase==="quote"){
    const rect = cv.getBoundingClientRect();
    const cw = rect.width, ch = rect.height;
    const btnW=120,btnH=34,btnY=ch-55,gap=16;
    const totalW=btnW*2+gap;
    const btn1X=(cw-totalW)/2;
    const btn2X=btn1X+btnW+gap;
    const{x,y}=getPos(e);

    // Home button
    if(x>=btn2X&&x<=btn2X+btnW&&y>=btnY&&y<=btnY+btnH){
      stopRainLoop();
      window.top.location.href="index.html";
      return;
    }
    // Replay button
    if(x>=btn1X&&x<=btn1X+btnW&&y>=btnY&&y<=btnY+btnH){
      stopRainLoop();
      rainPlaying=false;
      gs.phase="playing";gs.score=0;sky=null;
      gs.drops=[];gs.catchPs=[];gs.ripples=[];
      gs.endT=0;gs.dimAlpha=0;gs.rainFaded=false;gs.rbPs=null;
      scheduleGlow();lastTick=Date.now();
      resetRain();
      return;
    }
    return;
  }

  if(gs.phase!=="playing")return;

  const{x,y}=getPos(e);
  let best=Infinity,bi=-1;
  for(let i=0;i<gs.drops.length;i++){
    const d=gs.drops[i];if(!d.isGlowing||d.caught)continue;
    const dist=Math.hypot(x-d.x,y-d.y);
    if(dist<HIT_R&&dist<best){best=dist;bi=i;}
  }
  if(bi>=0){
    const d=gs.drops[bi];d.caught=true;gs.score++;
    gs.catchPs.push(...mkFx(d.x,d.y));
    gs.ripples.push(mkRip(d.x,d.y));chime();
    if(gs.score>=DROPS_TO_WIN){
      gs.phase="ending";gs.endT=0;
      gs.endQuote=QUOTES[quoteIndex % QUOTES.length];
      quoteIndex++;
      playEnd();
    }
  } else {
    gs.ripples.push(mkRip(x,y));
  }
}

cv.addEventListener("click",tap);
cv.addEventListener("touchstart",tap,{passive:false});

// === DRAW DROP ===
function drawDrop(d){
  c.save();
  if(d.isGlowing&&!d.caught){
    d.pulsePhase+=0.04;const p=0.6+Math.sin(d.pulsePhase)*0.4;
    // Outer purple glow
    const og=c.createRadialGradient(d.x,d.y,0,d.x,d.y,26);
    og.addColorStop(0,`rgba(180,120,255,${0.35*p})`);
    og.addColorStop(0.35,`rgba(150,100,240,${0.18*p})`);
    og.addColorStop(0.65,`rgba(130,80,220,${0.08*p})`);
    og.addColorStop(1,"rgba(120,70,200,0)");
    c.fillStyle=og;c.beginPath();c.ellipse(d.x,d.y,22,28,0,0,Math.PI*2);c.fill();
    // Inner glow
    const ig=c.createRadialGradient(d.x,d.y,0,d.x,d.y,10);
    ig.addColorStop(0,`rgba(220,200,255,${0.6*p})`);
    ig.addColorStop(1,`rgba(180,150,250,${0.25*p})`);
    c.fillStyle=ig;c.beginPath();c.ellipse(d.x,d.y,7,10,0,0,Math.PI*2);c.fill();
    // Core - oval shape like regular drops
    c.fillStyle=`rgba(240,230,255,${0.85*p*d.fadeOut})`;
    c.beginPath();c.ellipse(d.x,d.y,4,6,0,0,Math.PI*2);c.fill();
    // Bright center
    c.fillStyle=`rgba(255,255,255,${0.95*p*d.fadeOut})`;
    c.beginPath();c.ellipse(d.x,d.y,2,3.5,0,0,Math.PI*2);c.fill();
  } else {
    c.strokeStyle=`rgba(180,175,210,${d.opacity*d.fadeOut})`;c.lineWidth=d.width;c.lineCap="round";
    c.beginPath();c.moveTo(d.x+d.drift*5,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();
  }
  c.restore();
}

// === MAIN LOOP ===
let lastTick=Date.now();

function loop() {
  const now = Date.now();

 const rect = cv.getBoundingClientRect();
const cw = rect.width;
const ch = rect.height;

  // === BG ===
  const bg=c.createLinearGradient(0,0,0,ch);
  bg.addColorStop(0,"#0a0d14");bg.addColorStop(0.2,"#101520");bg.addColorStop(0.4,"#181f28");bg.addColorStop(0.6,"#1a1528");bg.addColorStop(1,"#120f1e");
  c.fillStyle=bg;c.fillRect(0,0,cw,ch);

  // Static stars - not blinking
  const stars=[
    {x:0.05,y:0.06,size:1.1,alpha:0.5},
    {x:0.12,y:0.14,size:0.9,alpha:0.4},
    {x:0.22,y:0.08,size:1.3,alpha:0.55},
    {x:0.30,y:0.18,size:0.8,alpha:0.35},
    {x:0.38,y:0.05,size:1.0,alpha:0.45},
    {x:0.48,y:0.12,size:1.2,alpha:0.5},
    {x:0.55,y:0.03,size:0.9,alpha:0.4},
    {x:0.65,y:0.10,size:1.1,alpha:0.45},
    {x:0.72,y:0.16,size:0.85,alpha:0.38},
    {x:0.82,y:0.07,size:1.25,alpha:0.52},
    {x:0.90,y:0.13,size:0.95,alpha:0.42},
    {x:0.96,y:0.04,size:1.0,alpha:0.48},
  ];
  stars.forEach(star=>{
    c.fillStyle=`rgba(220,210,240,${star.alpha})`;
    c.beginPath();
    c.arc(star.x*cw,star.y*ch,star.size,0,Math.PI*2);
    c.fill();
  });

  const isActive=gs.phase==="menu"||gs.phase==="playing"||gs.phase==="ending"||gs.phase==="quote";

  if(isActive){
    // Clouds
    gs.cloudOff+=0.08;
    c.save();c.globalAlpha=0.2;c.fillStyle="rgba(30,20,45,1)";
    for(let i=0;i<3;i++){
      const cx2=((gs.cloudOff*(0.2+i*0.15)+i*200)%(cw+300))-150;
      c.beginPath();c.ellipse(cx2,18+i*14,100+i*20,14+i*5,0,0,Math.PI*2);c.fill();
    }
    c.restore();

    // Skyline
    drawSky(cw,ch,now);

    // === RAIN SPAWNING ===
    const canSpawnRain=gs.phase==="playing"||gs.phase==="ending";
    const isMenu=gs.phase==="menu"||gs.phase==="quote";

    if(canSpawnRain&&now-gs.lastRain>RAIN_INT){
      for(let i=0;i<DENSE;i++) gs.drops.push(mkDrop(cw,ch,false));
      gs.lastRain=now;
    }
    if(isMenu&&now-gs.lastRain>100){
      for(let i=0;i<2;i++){const d=mkDrop(cw,ch,false);d.opacity=0.05+Math.random()*0.40;gs.drops.push(d);}
      gs.lastRain=now;
    }

    // Glow drop spawning — only during playing, with scheduled gaps
    if(gs.phase==="playing"&&now>=gs.nextGlow){
      gs.drops.push(mkDrop(cw,ch,true));
      scheduleGlow();
    }

// Cap (keep glowing drops; only trim regular rain)
const MAX_REGULAR = 500;
let regularCount = 0;

for (let i = gs.drops.length - 1; i >= 0; i--) {
  const d = gs.drops[i];

  if (!d.isGlowing) {
    regularCount++;
    if (regularCount > MAX_REGULAR) {
      gs.drops.splice(i, 1); // only remove regular drops
    }
  }
}

    // Update & draw drops
  for (let i = gs.drops.length - 1; i >= 0; i--) {
  const d = gs.drops[i];

  // Move
  d.y += d.speed;
  d.x += d.drift;

  // Mark "hit ground" only when it passes the bottom a bit
if (!d.grounded && (d.y + d.length/2) >= (ch + 2)) {
  d.grounded = true;
}

  // If caught, fade out (both types)
  if (d.caught) {
    d.fadeOut -= 0.08;
    if (d.fadeOut <= 0) {
      gs.drops.splice(i, 1);
      continue;
    }
  }

  // Glowing drops: only fade AFTER hitting the bottom
  if (d.isGlowing) {
    if (d.grounded) {
      d.fadeOut -= 0.04;
      if (d.fadeOut <= 0) {
        gs.drops.splice(i, 1);
        continue;
      }
    }
  } else {
    // Regular drops: remove once they go offscreen
    if (d.y > ch + 20) {
      gs.drops.splice(i, 1);
      continue;
    }
  }

  drawDrop(d);
}
    // Ground splashes
    if(gs.phase==="playing"){
      for(let i=0;i<2;i++){
        const sx=Math.random()*cw,sy=ch-2+Math.random()*3;
        c.fillStyle=`rgba(150,145,175,${0.04+Math.random()*0.04})`;
        c.beginPath();c.ellipse(sx,sy,2+Math.random()*3,1,0,0,Math.PI*2);c.fill();
      }
    }

    // Ripples
    for(let i=gs.ripples.length-1;i>=0;i--){
      const r=gs.ripples[i];r.radius+=r.speed;r.opacity-=0.01;
      if(r.opacity<=0){gs.ripples.splice(i,1);continue;}
      c.save();c.strokeStyle=`rgba(200,175,255,${r.opacity})`;c.lineWidth=1;
      c.beginPath();c.arc(r.x,r.y,r.radius,0,Math.PI*2);c.stroke();c.restore();
    }

    // Catch particles
    for(let i=gs.catchPs.length-1;i>=0;i--){
      const p=gs.catchPs[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.04;p.life-=0.016;
      if(p.life<=0){gs.catchPs.splice(i,1);continue;}
      c.save();c.globalAlpha=p.life;c.fillStyle=p.color+p.life+")";
      c.beginPath();c.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);c.fill();c.restore();
    }
  }

  // === PLAYING UI ===
  if(gs.phase==="playing"){
    // Vertical progress bar — left side
    const barW=5,barH=ch*0.6,barX=12,barY=(ch-barH)/2;
    const prog=Math.min(gs.score/DROPS_TO_WIN,1);
    c.fillStyle="rgba(255,255,255,0.06)";
    c.beginPath();c.roundRect(barX,barY,barW,barH,3);c.fill();
    if(prog>0){
      const fillH=barH*prog;
      const fg=c.createLinearGradient(0,barY+barH,0,barY+barH-fillH);
      fg.addColorStop(0,"rgba(180,140,240,0.4)");fg.addColorStop(1,"rgba(220,200,255,0.7)");
      c.fillStyle=fg;c.beginPath();c.roundRect(barX,barY+barH-fillH,barW,fillH,3);c.fill();
      c.shadowColor="rgba(180,140,240,0.35)";c.shadowBlur=6;
      c.beginPath();c.roundRect(barX,barY+barH-fillH,barW,fillH,3);c.fill();c.shadowBlur=0;
    }
    // Score text — below bar
    c.fillStyle="rgba(255,255,255,0.65)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText(`${gs.score}`,barX+barW/2,barY+barH+18);
    
  }

  // === MENU ===
  if(gs.phase==="menu"){
    gs.menuPulse+=0.018;
    const btnW=140,btnH=34,btnX=(cw-btnW)/2,btnY=ch-55;
    c.fillStyle="rgba(50,25,80,0.85)";
    c.beginPath();c.roundRect(btnX,btnY,btnW,btnH,17);c.fill();
    c.fillStyle=`rgba(253,224,71,${0.8+Math.sin(gs.menuPulse)*0.2})`;
    c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("tap to begin",cw/2,btnY+btnH/2+4);
  }
// === ENDING SEQUENCE TRANSITION ===
  if(gs.phase==="ending"){
    gs.endT+=0.005;
    const t=Math.min(gs.endT,1);

    // Fade rain audio
    if (!gs.rainFaded && t > 0.2) {
      const rainEl = document.getElementById("rain");
      if(rainEl){
        // Gradually fade volume over 4 seconds using setInterval
        const startVol = rainEl.volume;
        const targetVol = IS_MOBILE ? 0.08 : 0.06;
        const steps = 80;
        let step = 0;
        const fadeInterval = setInterval(()=>{
          step++;
          rainEl.volume = Math.max(targetVol, startVol - (startVol - targetVol) * (step/steps));
          if(step >= steps) clearInterval(fadeInterval);
        }, 50);
      }
      gs.rainFaded = true;
    }

    // Fade to dark purple
    const r1=Math.floor(8+(18-8)*t),g1=Math.floor(6+(12-6)*t),b1=Math.floor(14+(30-14)*t);
    const r2=Math.floor(12+(25-12)*t),g2=Math.floor(8+(15-8)*t),b2=Math.floor(20+(40-20)*t);
    const tbg=c.createLinearGradient(0,0,0,ch);
    tbg.addColorStop(0,`rgb(${r1},${g1},${b1})`);tbg.addColorStop(1,`rgb(${r2},${g2},${b2})`);
    c.fillStyle=tbg;c.fillRect(0,0,cw,ch);

    // Fade remaining drops
    for(let i=gs.drops.length-1;i>=0;i--){
      const d = gs.drops[i];
      if (d.isGlowing) continue;
      d.opacity *= 0.95;
      if(d.opacity<0.003){gs.drops.splice(i,1);continue;}
      c.save();c.strokeStyle=`rgba(180,160,220,${d.opacity})`;c.lineWidth=d.width;c.lineCap="round";
      c.beginPath();c.moveTo(d.x,d.y-d.length/2);c.lineTo(d.x,d.y+d.length/2);c.stroke();c.restore();
      d.y+=d.speed;
    }

    // Spawn floating pills
    if(t>0.3){
      if(!gs.rbPs||gs.rbPs.length===0){
        gs.rbPs=[];
        // Yellow/orange/amber palette for city night vibe
        const cols=["#fbbf24","#f59e0b","#fcd34d","#fb923c","#fdba74","#fef08a","#c084fc","#e879f9"];
        for(let i=0;i<100;i++) gs.rbPs.push({
          x:Math.random()*cw, y:Math.random()*ch,
          size:2+Math.random()*5,
          color:cols[Math.floor(Math.random()*cols.length)],
          speed:0.15+Math.random()*0.4,
          wobble:Math.random()*Math.PI*2,
          wobbleSpd:0.008+Math.random()*0.015,
          opacity:0,
          target:0.4+Math.random()*0.4,
          shape:Math.random()>0.5?"c":"d",
        });
      }
      const po=(t-0.3)/0.7;
      gs.rbPs.forEach(p=>{
        p.wobble+=p.wobbleSpd; p.y-=p.speed*0.3; p.x+=Math.sin(p.wobble)*0.3;
        if(p.y<-10) p.y=ch+10;
        c.save(); c.globalAlpha=p.target*po*0.5; c.fillStyle=p.color;
        if(p.shape==="c"){c.beginPath();c.arc(p.x,p.y,p.size,0,Math.PI*2);c.fill();}
        else{c.translate(p.x,p.y);c.rotate(Math.PI/4);c.fillRect(-p.size/2,-p.size/2,p.size,p.size);}
        c.restore();
      });
    }

    if(gs.endT>1.3){gs.phase="quote";gs.quoteStartTime=Date.now();}
  }

  // === QUOTE SCREEN — DARK PURPLE ===
  if(gs.phase==="quote"){
    const rg=c.createLinearGradient(0,0,0,ch);
    rg.addColorStop(0,"#0a0d14");rg.addColorStop(0.5,"#101520");rg.addColorStop(1,"#120f1e");
    c.fillStyle=rg;c.fillRect(0,0,cw,ch);

    // Floating particles - yellow/orange/purple
    if(gs.rbPs) gs.rbPs.forEach(p=>{
      p.wobble+=p.wobbleSpd; p.y-=p.speed*0.2; p.x+=Math.sin(p.wobble)*0.25;
      if(p.opacity<p.target) p.opacity+=0.006;
      if(p.y<-10){p.y=ch+10; p.x=Math.random()*cw;}
      c.save(); c.globalAlpha=p.opacity*0.7; c.fillStyle=p.color;
      if(p.shape==="c"){c.beginPath();c.arc(p.x,p.y,p.size,0,Math.PI*2);c.fill();}
      else{c.translate(p.x,p.y);c.rotate(Math.PI/4);c.fillRect(-p.size/2,-p.size/2,p.size,p.size);}
      c.restore();
    });

    // Quote — fade in, hold, fade out
    const quoteAge = (Date.now() - gs.quoteStartTime) / 1000;
    const quoteFade = quoteAge<7?1:Math.max(0,1-(quoteAge-7)/2);

    if(quoteFade > 0 && gs.endQuote){
      c.save();
      c.globalAlpha = quoteFade;

      // Measure text to fit background to content
      c.font = "italic 600 22px 'Helvetica Neue',sans-serif";
      const maxW = cw * 0.72;
      const words = gs.endQuote.split(" ");
      let lines = [], cur = "";
      for(const w of words){
        const test = cur ? cur + " " + w : w;
        if(c.measureText(test).width > maxW && cur){ lines.push(cur); cur = w; }
        else cur = test;
      }
      if(cur) lines.push(cur);

      const lh = 34;
      const padX = 28, padY = 18;
      // Find widest line for pill width
      let maxLineW = 0;
      lines.forEach(l => { const w = c.measureText(l).width; if(w > maxLineW) maxLineW = w; });
      const pillW = maxLineW + padX * 2;
      const pillH = lines.length * lh + padY * 2;
      const pillX = (cw - pillW) / 2;
      const pillY = ch / 2 - pillH / 2;

      // Pill background - dark semi-transparent purple
      c.globalAlpha = quoteFade * 0.88;
      c.fillStyle = "rgba(20,12,40,0.75)";
      c.beginPath(); c.roundRect(pillX, pillY, pillW, pillH, 14); c.fill();

      // Subtle border
      c.globalAlpha = quoteFade * 0.5;
      c.strokeStyle = "rgba(180,140,255,0.3)";
      c.lineWidth = 1;
      c.stroke();

      // Text
      c.globalAlpha = quoteFade;
      c.fillStyle = "rgba(235,225,255,0.95)";
      c.textAlign = "center";
      c.textBaseline = "middle";
      lines.forEach((l, i) => c.fillText(l, cw/2, pillY + padY + lh*0.5 + i * lh));

      c.restore();
    }

    // Replay and Home buttons
    const btnW=120,btnH=34,btnY=ch-55,gap=16;
    const totalW=btnW*2+gap;
    const btn1X=(cw-totalW)/2;
    const btn2X=btn1X+btnW+gap;

    // Replay
    c.fillStyle="rgba(50,25,80,0.85)";
    c.beginPath();c.roundRect(btn1X,btnY,btnW,btnH,17);c.fill();
    c.fillStyle="rgba(253,224,71,0.95)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("replay",btn1X+btnW/2,btnY+btnH/2+4);

    // Home
    c.fillStyle="rgba(50,25,80,0.85)";
    c.beginPath();c.roundRect(btn2X,btnY,btnW,btnH,17);c.fill();
    c.fillStyle="rgba(253,224,71,0.95)";c.font="600 13px 'Helvetica Neue',sans-serif";
    c.textAlign="center";c.fillText("home",btn2X+btnW/2,btnY+btnH/2+4);
  }

  requestAnimationFrame(loop);
}

scheduleGlow();
requestAnimationFrame(loop);
</script>
</body>
</html>
